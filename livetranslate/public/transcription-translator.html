<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Transcription Translator</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: Arial, sans-serif;
        background: #f0f0f0;
        color: #000;
        line-height: 1.4;
        font-size: 12px;
      }
      .container {
        max-width: 1600px;
        margin: 0 auto;
        background: #fff;
        border: 1px solid #ccc;
      }
      .header {
        background: #1565c0;
        color: #fff;
        padding: 15px;
        text-align: center;
        border-bottom: 3px solid #000;
      }
      .header h1 {
        font-size: 18px;
        margin-bottom: 5px;
        font-weight: 700;
      }
      .header p {
        font-size: 12px;
      }
      .content {
        padding: 20px;
      }
      .controls {
        background: #fff;
        border: 1px solid #ccc;
        padding: 15px;
        margin-bottom: 20px;
        display: flex;
        gap: 15px;
        align-items: flex-start;
        flex-wrap: wrap;
      }
      .control-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }
      label {
        font-weight: 700;
        color: #000;
        font-size: 12px;
      }
      select,
      input {
        padding: 6px;
        border: 1px solid #999;
        font-size: 12px;
        min-width: 200px;
        background: #fff;
      }
      textarea {
        padding: 6px;
        border: 1px solid #999;
        font-size: 11px;
        width: 100%;
        background: #fff;
        font-family: monospace;
      }
      .btn {
        background: #1565c0;
        color: #fff;
        border: 1px solid #000;
        padding: 6px 12px;
        font-size: 12px;
        font-weight: 700;
        cursor: pointer;
      }
      .btn:hover {
        background: #0d47a1;
      }
      .btn:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      .btn-danger {
        background: #c62828;
      }
      .btn-danger:hover {
        background: #b71c1c;
      }
      .translator-list {
        background: #fff;
        border: 1px solid #ccc;
        padding: 15px;
        margin-bottom: 20px;
      }
      .translator-item {
        background: #f5f5f5;
        border: 1px solid #ddd;
        padding: 10px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .translator-item.active {
        border-color: #1565c0;
        background: #e3f2fd;
      }
      .translator-info {
        flex: 1;
      }
      .translator-id {
        font-weight: 700;
        margin-bottom: 5px;
      }
      .translator-stats {
        font-size: 11px;
        color: #666;
      }
      .translator-actions {
        display: flex;
        gap: 5px;
      }
      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
      }
      .stat-card {
        background: #1565c0;
        color: #fff;
        padding: 15px;
        border: 1px solid #000;
        text-align: center;
      }
      .stat-number {
        font-size: 18px;
        font-weight: 700;
        margin-bottom: 5px;
      }
      .stat-label {
        font-size: 11px;
        font-weight: 700;
      }
      .sections {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }
      .section {
        border: 1px solid #ccc;
        background: #fff;
      }
      .section-header {
        background: #1565c0;
        color: #fff;
        padding: 10px;
        font-weight: 700;
        text-align: center;
      }
      .section-content {
        padding: 15px;
        max-height: 500px;
        overflow-y: auto;
      }
      .translation-item {
        background: #fff;
        border: 1px solid #ccc;
        padding: 12px;
        margin-bottom: 10px;
        border-radius: 3px;
      }
      .translation-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
        padding-bottom: 5px;
        border-bottom: 1px solid #ddd;
      }
      .translation-time {
        font-size: 10px;
        color: #666;
        font-weight: 700;
      }
      .translation-status {
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 3px;
        font-weight: 700;
        text-transform: uppercase;
      }
      .translation-status.success {
        background: #c8e6c9;
        color: #2e7d32;
      }
      .translation-status.error {
        background: #ffcdd2;
        color: #c62828;
      }
      .translation-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-top: 8px;
      }
      .translation-source,
      .translation-target {
        padding: 8px;
        border-radius: 3px;
      }
      .translation-source {
        background: #fff9c4;
        border: 1px solid #f9a825;
      }
      .translation-target {
        background: #e3f2fd;
        border: 1px solid #1565c0;
      }
      .translation-label {
        font-size: 9px;
        font-weight: 700;
        text-transform: uppercase;
        margin-bottom: 5px;
        opacity: 0.7;
      }
      .translation-text {
        font-size: 12px;
        color: #000;
        line-height: 1.5;
        white-space: pre-wrap;
      }
      .translation-meta {
        font-size: 10px;
        color: #666;
        margin-top: 5px;
      }
      .translation-error {
        font-size: 11px;
        color: #c62828;
        font-style: italic;
      }
      .log-item {
        background: #fff;
        border: 1px solid #ccc;
        padding: 8px;
        margin-bottom: 6px;
        font-family: monospace;
        font-size: 10px;
      }
      .log-timestamp {
        color: #000;
        font-weight: 700;
      }
      .log-type {
        color: #1565c0;
        font-weight: 700;
        margin: 0 8px;
      }
      .log-message {
        color: #000;
      }
      .empty-state {
        text-align: center;
        padding: 40px;
        color: #666;
      }
      .empty-state h3 {
        margin-bottom: 10px;
        color: #000;
        font-weight: 700;
      }
      @media (max-width: 1024px) {
        .sections {
          grid-template-columns: 1fr;
        }
        .translation-content {
          grid-template-columns: 1fr;
        }
        .controls {
          flex-direction: column;
        }
        .control-group {
          width: 100%;
        }
        select,
        input {
          min-width: auto;
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üåç Transcription Translator</h1>
        <p>–°–µ—Ä–≤–µ—Ä–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–π</p>
      </div>
      <div class="content">
        <div class="translator-list">
          <h3 style="margin-bottom:15px;font-size:14px">–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–µ—Ä–µ–≤–æ–¥—á–∏–∫–∏</h3>
          <div id="translatorsList">
            <div class="empty-state">
              <p>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–µ—Ä–µ–≤–æ–¥—á–∏–∫–æ–≤</p>
            </div>
          </div>
        </div>
        <div class="controls">
          <div class="control-group">
            <label for="normalizerSelect">–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ç–æ—Ä</label>
            <select id="normalizerSelect">
              <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ç–æ—Ä...</option>
            </select>
          </div>
          <div class="control-group">
            <label for="sourceLanguage">–ò—Å—Ö–æ–¥–Ω—ã–π —è–∑—ã–∫</label>
            <select id="sourceLanguage">
              <option value="kazakh">–ö–∞–∑–∞—Ö—Å–∫–∏–π</option>
              <option value="russian">–†—É—Å—Å–∫–∏–π</option>
              <option value="english">–ê–Ω–≥–ª–∏–π—Å–∫–∏–π</option>
            </select>
          </div>
          <div class="control-group">
            <label for="targetLanguage">–¶–µ–ª–µ–≤–æ–π —è–∑—ã–∫</label>
            <select id="targetLanguage">
              <option value="russian" selected>–†—É—Å—Å–∫–∏–π</option>
              <option value="english">–ê–Ω–≥–ª–∏–π—Å–∫–∏–π</option>
              <option value="kazakh">–ö–∞–∑–∞—Ö—Å–∫–∏–π</option>
              <option value="chinese">–ö–∏—Ç–∞–π—Å–∫–∏–π</option>
            </select>
          </div>
          <div class="control-group">
            <label>
              <input
                type="checkbox"
                id="autoTranslateCheck"
                checked
                style="min-width:auto;width:auto"
              />
              –ê–≤—Ç–æ
            </label>
          </div>
          <div class="control-group">
            <button class="btn" id="createTranslatorBtn">+ –°–æ–∑–¥–∞—Ç—å</button>
          </div>
        </div>
        <div class="controls">
          <div class="control-group" style="flex:1">
            <label for="promptInput">–ü—Ä–æ–º–ø—Ç –¥–ª—è ChatGPT</label>
            <textarea id="promptInput" rows="4">
–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥—á–∏–∫ —Å –∫–∞–∑–∞—Ö—Å–∫–æ–≥–æ –Ω–∞ —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫.

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∫–∞–∑–∞—Ö—Å–∫–∏–π —Ç–µ–∫—Å—Ç –Ω–∞ —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫.

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
1. –ü–µ—Ä–µ–≤–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ç–æ—á–Ω—ã–º –∏ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å —Å–º—ã—Å–ª –æ—Ä–∏–≥–∏–Ω–∞–ª–∞
2. –ò—Å–ø–æ–ª—å–∑—É–π –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫
3. –°–æ—Ö—Ä–∞–Ω—è–π —Å—Ç–∏–ª—å –∏ —Ç–æ–Ω –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
4. –ï—Å–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ –µ—Å—Ç—å –∏–º–µ–Ω–∞ –∏–ª–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã, —Å–æ—Ö—Ä–∞–Ω—è–π –∏—Ö
5. –í–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–≤–æ–¥ –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
            </textarea>
          </div>
        </div>
        <div class="stats" id="stats" style="display:none">
          <div class="stat-card">
            <div class="stat-number" id="translatedCount">0</div>
            <div class="stat-label">–ü–µ—Ä–µ–≤–µ–¥–µ–Ω–æ</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="errorCount">0</div>
            <div class="stat-label">–û—à–∏–±–æ–∫</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="tokensUsed">0</div>
            <div class="stat-label">–¢–æ–∫–µ–Ω–æ–≤</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="connectionStatus">-</div>
            <div class="stat-label">–°—Ç–∞—Ç—É—Å</div>
          </div>
        </div>
        <div class="section" id="translationsSection" style="display:none">
          <div class="section-header">üåç –ü–µ—Ä–µ–≤–æ–¥—ã</div>
          <div class="section-content" id="translationsList">
            <div class="empty-state">
              <h3>–ù–µ—Ç</h3>
            </div>
          </div>
        </div>
        <div class="section" id="logsSection" style="display:none">
          <div class="section-header">üìã –õ–æ–≥–∏</div>
          <div class="section-content" id="logsList">
            <div class="empty-state">
              <h3>–ù–µ—Ç</h3>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script>
      const app = {
        translators: [],
        currentTranslatorId: null,
        ws: null,
        data: {
          results: [],
          logs: [],
          stats: null,
        },
        async init() {
          await this.loadNormalizers();
          await this.loadTranslators();
          this.setupEvents();
          const t = localStorage.getItem('translator_prompt');
          if (t) {
            document.getElementById('promptInput').value = t;
          }
          setInterval(() => this.loadTranslators(), 5000);
        },
        async loadNormalizers() {
          try {
            const normalizers = await (await fetch('/api/normalizer')).json();
            const normalizerSelect = document.getElementById('normalizerSelect');
            normalizerSelect.innerHTML =
              '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ...</option>';
            normalizers.forEach((normalizer) => {
              const option = document.createElement('option');
              option.value = normalizer.id;
              option.textContent = `${normalizer.id} (${normalizer.status})`;
              normalizerSelect.appendChild(option);
            });
          } catch (err) {
            console.error('Load normalizers error:', err);
          }
        },
        async loadTranslators() {
          try {
            const resp = await fetch('/api/translator');
            this.translators = await resp.json();
            this.renderTranslators();
          } catch (err) {
            console.error('Load translators error:', err);
          }
        },
        renderTranslators() {
          const list = document.getElementById('translatorsList');
          if (this.translators.length === 0) {
            list.innerHTML =
              '<div class="empty-state"><p>–ù–µ—Ç</p></div>';
            return;
          }
          list.innerHTML = this.translators
            .map(
              (trans) => `
                  <div class="translator-item ${
                    trans.id === this.currentTranslatorId ? 'active' : ''
                  }">
                    <div class="translator-info">
                      <div class="translator-id">${trans.id}</div>
                      <div class="translator-stats">
                        Normalizer: ${trans.normalizerId} | ${trans.status} | OK: ${
                  trans.stats.translationsCompleted
                } | Err: ${trans.stats.translationsFailed} | ${trans.stats.sourceLanguage} ‚Üí ${trans.stats.targetLanguage}
                      </div>
                    </div>
                    <div class="translator-actions">
                      <button class="btn" onclick="app.select('${
                        trans.id
                      }')">–û—Ç–∫—Ä—ã—Ç—å</button>
                      <button class="btn btn-danger" onclick="app.delete('${
                        trans.id
                      }')">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                  </div>
                `
            )
            .join('');
        },
        setupEvents() {
          document.getElementById('createTranslatorBtn').onclick = () =>
            this.create();
          document.getElementById('promptInput').onchange = () => {
            localStorage.setItem(
              'translator_prompt',
              document.getElementById('promptInput').value
            );
          };
        },
        async create() {
          const normalizerId = document.getElementById('normalizerSelect').value;
          if (!normalizerId) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ç–æ—Ä');
            return;
          }
          try {
            const resp = await fetch('/api/translator', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                normalizerId: normalizerId,
                model: 'gpt-4o',
                prompt: document.getElementById('promptInput').value,
                autoTranslate: document.getElementById('autoTranslateCheck')
                  .checked,
                sourceLanguage: document.getElementById('sourceLanguage').value,
                targetLanguage: document.getElementById('targetLanguage').value
              }),
            });
            if (!resp.ok) {
              throw new Error((await resp.json()).error);
            }
            const newTrans = await resp.json();
            await this.loadTranslators();
            this.select(newTrans.id);
          } catch (err) {
            alert('–û—à–∏–±–∫–∞: ' + err.message);
          }
        },
        async delete(id) {
          if (!confirm('–£–¥–∞–ª–∏—Ç—å?')) return;
          try {
            await fetch(`/api/translator/${id}`, { method: 'DELETE' });
            if (this.currentTranslatorId === id) {
              this.disconnect();
              this.currentTranslatorId = null;
              document.getElementById('stats').style.display = 'none';
              document.getElementById('translationsSection').style.display =
                'none';
              document.getElementById('logsSection').style.display = 'none';
            }
            await this.loadTranslators();
          } catch (err) {
            alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
          }
        },
        select(id) {
          this.currentTranslatorId = id;
          this.renderTranslators();
          this.connect();
          document.getElementById('stats').style.display = 'grid';
          document.getElementById('translationsSection').style.display = 'block';
          document.getElementById('logsSection').style.display = 'block';
        },
        connect() {
          this.disconnect();
          if (!this.currentTranslatorId) return;
          this.ws = new WebSocket(
            `${location.protocol === 'https:' ? 'wss:' : 'ws:'}//${
              location.host
            }/translator?id=${this.currentTranslatorId}`
          );
          this.ws.onopen = () =>
            (document.getElementById('connectionStatus').textContent =
              '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ');
          this.ws.onmessage = (evt) =>
            this.handleMsg(JSON.parse(evt.data));
          this.ws.onclose = () =>
            (document.getElementById('connectionStatus').textContent =
              '–û—Ç–∫–ª—é—á–µ–Ω–æ');
        },
        disconnect() {
          if (this.ws) {
            this.ws.close();
            this.ws = null;
          }
        },
        handleMsg(msg) {
          switch (msg.type) {
            case 'initial_data':
              this.data.results = msg.data.results || [];
              this.data.logs = msg.data.logs || [];
              this.data.stats = msg.data.stats;
              this.renderAll();
              break;
            case 'normalization_received':
              // –ú–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
              console.log('New normalization received:', msg.data);
              break;
            case 'translation_completed':
            case 'translation_failed':
              this.data.results.unshift(msg.data);
              if (this.data.results.length > 20) {
                this.data.results = this.data.results.slice(0, 20);
              }
              this.renderResults();
              this.loadTranslators();
              break;
            case 'log':
              this.data.logs.unshift(msg.data);
              if (this.data.logs.length > 50) {
                this.data.logs = this.data.logs.slice(0, 50);
              }
              this.renderLogs();
              break;
          }
          if (msg.data && msg.data.stats) {
            this.data.stats = msg.data.stats;
            this.updateStats();
          }
        },
        renderAll() {
          this.renderResults();
          this.renderLogs();
          this.updateStats();
        },
        renderResults() {
          const list = document.getElementById('translationsList');
          if (this.data.results.length === 0) {
            list.innerHTML =
              '<div class="empty-state"><h3>–ù–µ—Ç</h3></div>';
            return;
          }
          list.innerHTML = this.data.results
            .map(
              (res) => `
                <div class="translation-item">
                  <div class="translation-header">
                    <div class="translation-time">${new Date(
                      res.timestamp
                    ).toLocaleString('ru-RU')}</div>
                    <div class="translation-status ${
                      res.success ? 'success' : 'error'
                    }">${res.success ? 'OK' : 'ERR'}</div>
                  </div>
                  ${
                    res.success
                      ? `<div class="translation-content">
                          <div class="translation-source">
                            <div class="translation-label">${res.sourceLanguage || '–ò—Å—Ö–æ–¥–Ω—ã–π'}</div>
                            <div class="translation-text">${res.sourceText}</div>
                          </div>
                          <div class="translation-target">
                            <div class="translation-label">${res.targetLanguage || '–ü–µ—Ä–µ–≤–æ–¥'}</div>
                            <div class="translation-text">${res.translatedText}</div>
                          </div>
                        </div>
                        <div class="translation-meta">–¢–æ–∫–µ–Ω–æ–≤: ${res.tokensUsed || 0} | ${res.duration || 0}–º—Å</div>`
                      : `<div class="translation-error">${res.error}</div>`
                  }
                </div>
              `
            )
            .join('');
        },
        renderLogs() {
          const list = document.getElementById('logsList');
          if (this.data.logs.length === 0) {
            list.innerHTML = '<div class="empty-state"><h3>–ù–µ—Ç</h3></div>';
            return;
          }
          list.innerHTML = this.data.logs
            .map(
              (log) =>
                `<div class="log-item"><span class="log-timestamp">${new Date(
                  log.timestamp
                ).toLocaleString('ru-RU')}</span><span class="log-type">[${log.type}]</span><span class="log-message">${log.message}</span></div>`
            )
            .join('');
        },
        updateStats() {
          if (!this.data.stats) return;
          const stats = this.data.stats;
          document.getElementById('translatedCount').textContent =
            stats.translationsCompleted || 0;
          document.getElementById('errorCount').textContent =
            stats.translationsFailed || 0;
          document.getElementById('tokensUsed').textContent =
            stats.totalTokensUsed || 0;
        },
      };
      app.init();
    </script>
  </body>
</html>

