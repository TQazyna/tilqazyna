<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTMP Transcription Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #f0f0f0;
            color: #000;
            line-height: 1.4;
            font-size: 12px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border: 1px solid #ccc;
        }

        .header {
            background: #800080;
            color: white;
            padding: 15px;
            text-align: center;
            border-bottom: 3px solid #000;
        }

        .header h1 {
            font-size: 18px;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .header p {
            font-size: 12px;
        }

        .content {
            padding: 20px;
        }

        .controls {
            background: #fff;
            border: 1px solid #ccc;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        label {
            font-weight: bold;
            color: #000;
            font-size: 12px;
        }

        select, input {
            padding: 6px;
            border: 1px solid #999;
            font-size: 12px;
            min-width: 200px;
            background: #fff;
        }

        select:focus, input:focus {
            outline: 2px solid #800080;
            border-color: #800080;
        }

        .btn {
            background: #800080;
            color: white;
            border: 1px solid #000;
            padding: 6px 12px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
        }

        .btn:hover {
            background: #600060;
        }

        .btn-danger {
            background: #cc0000;
        }

        .btn-danger:hover {
            background: #aa0000;
        }

        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            border-bottom: 1px solid #ccc;
        }

        .tab {
            padding: 6px 12px;
            background: #fff;
            border: 1px solid #ccc;
            border-bottom: none;
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
        }

        .tab.active {
            background: #800080;
            color: white;
            border-color: #800080;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .transcription-item {
            background: white;
            border: 1px solid #ccc;
            padding: 15px;
            margin-bottom: 10px;
        }

        .transcription-item:hover {
            border-color: #800080;
        }

        .transcription-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            border-bottom: 1px solid #ccc;
            padding-bottom: 5px;
        }

        .transcription-id {
            font-size: 12px;
            color: #000;
            font-family: monospace;
            font-weight: bold;
        }

        .transcription-time {
            font-size: 12px;
            color: #000;
            font-weight: bold;
        }

        .transcription-text {
            font-size: 14px;
            line-height: 1.4;
            color: #000;
            margin-bottom: 8px;
        }

        .transcription-duration {
            font-size: 12px;
            color: #000;
            font-weight: bold;
        }

        .log-item {
            background: white;
            border: 1px solid #ccc;
            padding: 8px;
            margin-bottom: 6px;
            font-family: monospace;
            font-size: 11px;
        }

        .log-timestamp {
            color: #000;
            font-weight: bold;
        }

        .log-type {
            color: #800080;
            font-weight: bold;
            margin: 0 8px;
        }

        .log-message {
            color: #000;
        }

        .log-data {
            color: #000;
            margin-top: 5px;
            font-size: 11px;
        }

        .log-error {
            border-color: #cc0000;
            background: #FFB6C1;
        }

        .log-transcription {
            border-color: #006600;
            background: #90EE90;
        }

        .log-audio {
            border-color: #FF8C00;
            background: #FFD700;
        }

        .log-session {
            border-color: #800080;
            background: #DDA0DD;
        }

        .response-event-item {
            background: white;
            border: 1px solid #ccc;
            padding: 12px;
            margin-bottom: 8px;
            font-family: monospace;
            font-size: 11px;
        }

        .response-event-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }

        .response-event-id {
            font-size: 12px;
            color: #000;
            font-weight: bold;
        }

        .response-event-time {
            font-size: 12px;
            color: #000;
            font-weight: bold;
        }

        .response-event-type {
            background: #e3f2fd;
            color: #1976d2;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .response-event-data {
            color: #000;
            margin-top: 5px;
            font-size: 11px;
            background: #f5f5f5;
            padding: 8px;
            border-radius: 3px;
            max-height: 200px;
            overflow-y: auto;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #800080;
            color: white;
            padding: 15px;
            border: 1px solid #000;
            text-align: center;
        }

        .stat-number {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            font-weight: bold;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #000;
            border: 1px solid #ccc;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #000;
            font-weight: bold;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #ccc;
            border-top-color: #800080;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .auto-refresh input[type="checkbox"] {
            min-width: auto;
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .control-group {
                width: 100%;
            }

            select, input {
                min-width: auto;
                width: 100%;
            }

            .stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìù RTMP Transcription Viewer</h1>
            <p>–ü—Ä–æ—Å–º–æ—Ç—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ (—Ç–æ–ª—å–∫–æ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è, –±–µ–∑ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤)</p>
        </div>

        <div class="content">
            <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
            <div class="controls">
                <div class="control-group">
                    <label for="relaySelect">–†–µ—Ç—Ä–∞–Ω—Å–ª—è—Ç–æ—Ä</label>
                    <select id="relaySelect">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ—Ç—Ä–∞–Ω—Å–ª—è—Ç–æ—Ä...</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="logTypeSelect">–¢–∏–ø –ª–æ–≥–æ–≤</label>
                    <select id="logTypeSelect">
                        <option value="">–í—Å–µ –ª–æ–≥–∏</option>
                        <option value="transcription">–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è</option>
                        <option value="audio">–ê—É–¥–∏–æ</option>
                        <option value="session">–°–µ—Å—Å–∏—è</option>
                        <option value="error">–û—à–∏–±–∫–∏</option>
                        <option value="speech">–†–µ—á—å</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="limitInput">–õ–∏–º–∏—Ç –∑–∞–ø–∏—Å–µ–π</label>
                    <input type="number" id="limitInput" value="50" min="1" max="200">
                </div>
                <div class="control-group">
                    <button class="btn" id="refreshBtn">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
                </div>
                <div class="control-group">
                    <button class="btn btn-danger" id="clearBtn">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
                </div>
                <div class="control-group auto-refresh">
                    <input type="checkbox" id="autoRefresh" checked>
                    <label for="autoRefresh">–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (5 —Å–µ–∫)</label>
                </div>
            </div>

            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="stats" id="stats">
                <div class="stat-card">
                    <div class="stat-number" id="transcriptionCount">0</div>
                    <div class="stat-label">–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–π</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="logsCount">0</div>
                    <div class="stat-label">–õ–æ–≥–æ–≤</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="relayStatus">-</div>
                    <div class="stat-label">–°—Ç–∞—Ç—É—Å</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="lastUpdate">-</div>
                    <div class="stat-label">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</div>
                </div>
            </div>

            <!-- –í–∫–ª–∞–¥–∫–∏ -->
            <div class="tabs">
                <button class="tab active" data-tab="transcription">üìù –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è</button>
                <button class="tab" data-tab="logs">üìã –õ–æ–≥–∏</button>
                <button class="tab" data-tab="response-events">‚ö° Response Events</button>
            </div>

            <!-- –ö–æ–Ω—Ç–µ–Ω—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ -->
            <div class="tab-content active" id="transcription-content">
                <div id="transcriptionList">
                    <div class="empty-state">
                        <h3>–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏</h3>
                        <p>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ—Ç—Ä–∞–Ω—Å–ª—è—Ç–æ—Ä –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</p>
                    </div>
                </div>
            </div>

            <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –ª–æ–≥–æ–≤ -->
            <div class="tab-content" id="logs-content">
                <div id="logsList">
                    <div class="empty-state">
                        <h3>–ù–µ—Ç –ª–æ–≥–æ–≤</h3>
                        <p>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ—Ç—Ä–∞–Ω—Å–ª—è—Ç–æ—Ä –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–æ–≤</p>
                    </div>
                </div>
            </div>

            <!-- –ö–æ–Ω—Ç–µ–Ω—Ç response —Å–æ–±—ã—Ç–∏–π -->
            <div class="tab-content" id="response-events-content">
                <div id="responseEventsList">
                    <div class="empty-state">
                        <h3>–ù–µ—Ç response —Å–æ–±—ã—Ç–∏–π</h3>
                        <p>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ—Ç—Ä–∞–Ω—Å–ª—è—Ç–æ—Ä –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ response.done —Å–æ–±—ã—Ç–∏–π</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class TranscriptionViewer {
            constructor() {
                this.relays = [];
                this.currentRelayId = null;
                this.autoRefreshInterval = null;
                this.ws = null;
                this.init();
            }

            async init() {
                await this.loadRelays();
                this.setupEventListeners();
                this.startAutoRefresh();
            }

            async loadRelays() {
                try {
                    const response = await fetch('/api/rtmp-relay');
                    this.relays = await response.json();
                    
                    const relaySelect = document.getElementById('relaySelect');
                    relaySelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ—Ç—Ä–∞–Ω—Å–ª—è—Ç–æ—Ä...</option>';
                    
                    this.relays.forEach(relay => {
                        const option = document.createElement('option');
                        option.value = relay.id;
                        option.textContent = `${relay.id} (${relay.status}) - ${relay.rtmpUrl}`;
                        relaySelect.appendChild(option);
                    });
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ—Ç—Ä–∞–Ω—Å–ª—è—Ç–æ—Ä–æ–≤:', error);
                }
            }

            setupEventListeners() {
                document.getElementById('relaySelect').addEventListener('change', (e) => {
                    this.currentRelayId = e.target.value;
                    if (this.currentRelayId) {
                        this.connectWebSocket();
                        this.loadData();
                    } else {
                        this.disconnectWebSocket();
                    }
                });

                document.getElementById('refreshBtn').addEventListener('click', () => {
                    this.loadData();
                });

                document.getElementById('clearBtn').addEventListener('click', () => {
                    this.clearData();
                });

                document.getElementById('autoRefresh').addEventListener('change', (e) => {
                    if (e.target.checked) {
                        this.startAutoRefresh();
                    } else {
                        this.stopAutoRefresh();
                    }
                });

                // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        const tabName = e.target.dataset.tab;
                        this.switchTab(tabName);
                    });
                });
            }

            switchTab(tabName) {
                // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö –≤–∫–ª–∞–¥–æ–∫ –∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

                // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –≤–∫–ª–∞–¥–∫–µ –∏ –∫–æ–Ω—Ç–µ–Ω—Ç—É
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
                document.getElementById(`${tabName}-content`).classList.add('active');
            }

            async loadData() {
                if (!this.currentRelayId) return;

                try {
                    await Promise.all([
                        this.loadTranscription(),
                        this.loadLogs(),
                        this.loadResponseEvents(),
                        this.loadStats()
                    ]);
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
                }
            }

            async loadTranscription() {
                try {
                    const response = await fetch(`/api/rtmp-relay/${this.currentRelayId}/transcription`);
                    const data = await response.json();
                    this.renderTranscription(data.results);
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏:', error);
                }
            }

            async loadLogs() {
                try {
                    const logType = document.getElementById('logTypeSelect').value;
                    const limit = document.getElementById('limitInput').value;

                    let url = `/api/rtmp-relay/${this.currentRelayId}/logs?limit=${limit}`;
                    if (logType) {
                        url += `&type=${logType}`;
                    }

                    const response = await fetch(url);
                    const data = await response.json();
                    this.renderLogs(data.logs);
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ–≤:', error);
                }
            }

            async loadResponseEvents() {
                try {
                    const limit = document.getElementById('limitInput').value;

                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –ª–æ–≥–∏ –∏ —Ñ–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ response.done —Å–æ–±—ã—Ç–∏—è
                    const response = await fetch(`/api/rtmp-relay/${this.currentRelayId}/logs?limit=${limit}&type=realtime_event`);
                    const data = await response.json();

                    // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ —Å–æ–±—ã—Ç–∏—è —Å —Ç–∏–ø–æ–º response.done
                    const responseDoneEvents = data.logs.filter(log => {
                        try {
                            const eventData = typeof log.data === 'string' ? JSON.parse(log.data) : log.data;
                            return eventData && eventData.type === 'response.done';
                        } catch (e) {
                            return false;
                        }
                    });

                    this.renderResponseEvents(responseDoneEvents);
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ response —Å–æ–±—ã—Ç–∏–π:', error);
                }
            }

            async loadStats() {
                try {
                    const response = await fetch(`/api/rtmp-relay/${this.currentRelayId}`);
                    const data = await response.json();
                    
                    document.getElementById('transcriptionCount').textContent = data.details?.transcriptionCount || 0;
                    document.getElementById('logsCount').textContent = data.details?.logsCount || 0;
                    document.getElementById('relayStatus').textContent = data.status || '-';
                    document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('ru-RU');
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
                }
            }

            renderTranscription(results) {
                const container = document.getElementById('transcriptionList');
                
                if (!results || results.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏</h3>
                            <p>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞—É–¥–∏–æ</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = results.map(item => `
                    <div class="transcription-item">
                        <div class="transcription-header">
                            <div class="transcription-id">${item.id || 'N/A'}</div>
                            <div class="transcription-time">${new Date(item.timestamp).toLocaleString('ru-RU')}</div>
                        </div>
                        <div class="transcription-text">${item.transcript}</div>
                        ${item.duration ? `<div class="transcription-duration">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${item.duration}–º—Å</div>` : ''}
                    </div>
                `).join('');
            }

            renderLogs(logs) {
                const container = document.getElementById('logsList');

                if (!logs || logs.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>–ù–µ—Ç –ª–æ–≥–æ–≤</h3>
                            <p>–õ–æ–≥–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å –ø–æ—Å–ª–µ –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã —Ä–µ—Ç—Ä–∞–Ω—Å–ª—è—Ç–æ—Ä–∞</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = logs.map(log => {
                    const logClass = this.getLogClass(log.type);
                    return `
                        <div class="log-item ${logClass}">
                            <div>
                                <span class="log-timestamp">${new Date(log.timestamp).toLocaleString('ru-RU')}</span>
                                <span class="log-type">[${log.type}]</span>
                                <span class="log-message">${log.message}</span>
                            </div>
                            ${log.data ? `<div class="log-data">${JSON.stringify(log.data, null, 2)}</div>` : ''}
                        </div>
                    `;
                }).join('');
            }

            renderResponseEvents(events) {
                const container = document.getElementById('responseEventsList');

                if (!events || events.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>–ù–µ—Ç response —Å–æ–±—ã—Ç–∏–π</h3>
                            <p>Response.done —Å–æ–±—ã—Ç–∏—è –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞—É–¥–∏–æ</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = events.map(event => {
                    let eventData;
                    try {
                        eventData = typeof event.data === 'string' ? JSON.parse(event.data) : event.data;
                    } catch (e) {
                        eventData = { error: 'Invalid JSON', raw: event.data };
                    }

                    return `
                        <div class="response-event-item">
                            <div class="response-event-header">
                                <div class="response-event-id">${eventData.response?.id || 'N/A'}</div>
                                <div class="response-event-time">${new Date(event.timestamp).toLocaleString('ru-RU')}</div>
                                <div class="response-event-type">response.done</div>
                            </div>
                            <div class="response-event-data">${JSON.stringify(eventData, null, 2)}</div>
                        </div>
                    `;
                }).join('');
            }

            getLogClass(type) {
                switch (type) {
                    case 'error': return 'log-error';
                    case 'transcription': return 'log-transcription';
                    case 'audio': return 'log-audio';
                    case 'session': return 'log-session';
                    default: return '';
                }
            }

            async clearData() {
                if (!this.currentRelayId) return;
                
                if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ?')) {
                    return;
                }

                try {
                    await Promise.all([
                        fetch(`/api/rtmp-relay/${this.currentRelayId}/transcription`, { method: 'DELETE' }),
                        fetch(`/api/rtmp-relay/${this.currentRelayId}/logs`, { method: 'DELETE' })
                    ]);
                    
                    this.loadData();
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
                }
            }

            startAutoRefresh() {
                this.stopAutoRefresh();
                this.autoRefreshInterval = setInterval(() => {
                    if (this.currentRelayId) {
                        this.loadData();
                    }
                }, 5000);
            }

            stopAutoRefresh() {
                if (this.autoRefreshInterval) {
                    clearInterval(this.autoRefreshInterval);
                    this.autoRefreshInterval = null;
                }
            }

            connectWebSocket() {
                this.disconnectWebSocket();
                
                if (!this.currentRelayId) return;

                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/transcription?relay=${this.currentRelayId}`;
                
                this.ws = new WebSocket(wsUrl);

                this.ws.onopen = () => {
                    console.log('WebSocket connected for real-time transcription');
                };

                this.ws.onmessage = (event) => {
                    try {
                        const message = JSON.parse(event.data);
                        this.handleWebSocketMessage(message);
                    } catch (error) {
                        console.error('Error parsing WebSocket message:', error);
                    }
                };

                this.ws.onclose = () => {
                    console.log('WebSocket disconnected');
                    // –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
                    setTimeout(() => {
                        if (this.currentRelayId) {
                            this.connectWebSocket();
                        }
                    }, 3000);
                };

                this.ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                };
            }

            disconnectWebSocket() {
                if (this.ws) {
                    this.ws.close();
                    this.ws = null;
                }
            }

            handleWebSocketMessage(message) {
                switch (message.type) {
                    case 'initial_data':
                        this.renderTranscription(message.data.transcription);
                        this.renderLogs(message.data.logs);
                        this.loadResponseEvents(); // –û–±–Ω–æ–≤–ª—è–µ–º response —Å–æ–±—ã—Ç–∏—è –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
                        this.updateStats(message.data.status);
                        break;
                    case 'transcription':
                        this.addTranscriptionItem(message.data);
                        break;
                    case 'log':
                        this.addLogItem(message.data);
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ response.done —Å–æ–±—ã—Ç–∏–µ–º
                        if (message.data.type === 'realtime_event') {
                            try {
                                const eventData = typeof message.data.data === 'string' ? JSON.parse(message.data.data) : message.data.data;
                                if (eventData && eventData.type === 'response.done') {
                                    this.addResponseEventItem(message.data);
                                }
                            } catch (e) {
                                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞
                            }
                        }
                        break;
                }
            }

            addTranscriptionItem(transcription) {
                const container = document.getElementById('transcriptionList');
                
                // –£–±–∏—Ä–∞–µ–º empty state –µ—Å–ª–∏ –µ—Å—Ç—å
                const emptyState = container.querySelector('.empty-state');
                if (emptyState) {
                    emptyState.remove();
                }

                const item = document.createElement('div');
                item.className = 'transcription-item';
                item.innerHTML = `
                    <div class="transcription-header">
                        <div class="transcription-id">${transcription.id || 'N/A'}</div>
                        <div class="transcription-time">${new Date(transcription.timestamp).toLocaleString('ru-RU')}</div>
                    </div>
                    <div class="transcription-text">${transcription.transcript}</div>
                    ${transcription.duration ? `<div class="transcription-duration">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${transcription.duration}–º—Å</div>` : ''}
                `;

                container.insertBefore(item, container.firstChild);

                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                const items = container.querySelectorAll('.transcription-item');
                if (items.length > 50) {
                    items[items.length - 1].remove();
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
                const count = container.querySelectorAll('.transcription-item').length;
                document.getElementById('transcriptionCount').textContent = count;
            }

            addLogItem(log) {
                const container = document.getElementById('logsList');

                // –£–±–∏—Ä–∞–µ–º empty state –µ—Å–ª–∏ –µ—Å—Ç—å
                const emptyState = container.querySelector('.empty-state');
                if (emptyState) {
                    emptyState.remove();
                }

                const logClass = this.getLogClass(log.type);
                const item = document.createElement('div');
                item.className = `log-item ${logClass}`;
                item.innerHTML = `
                    <div>
                        <span class="log-timestamp">${new Date(log.timestamp).toLocaleString('ru-RU')}</span>
                        <span class="log-type">[${log.type}]</span>
                        <span class="log-message">${log.message}</span>
                    </div>
                    ${log.data ? `<div class="log-data">${JSON.stringify(log.data, null, 2)}</div>` : ''}
                `;

                container.insertBefore(item, container.firstChild);

                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                const items = container.querySelectorAll('.log-item');
                if (items.length > 100) {
                    items[items.length - 1].remove();
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
                const count = container.querySelectorAll('.log-item').length;
                document.getElementById('logsCount').textContent = count;
            }

            addResponseEventItem(log) {
                const container = document.getElementById('responseEventsList');

                // –£–±–∏—Ä–∞–µ–º empty state –µ—Å–ª–∏ –µ—Å—Ç—å
                const emptyState = container.querySelector('.empty-state');
                if (emptyState) {
                    emptyState.remove();
                }

                let eventData;
                try {
                    eventData = typeof log.data === 'string' ? JSON.parse(log.data) : log.data;
                } catch (e) {
                    eventData = { error: 'Invalid JSON', raw: log.data };
                }

                const item = document.createElement('div');
                item.className = 'response-event-item';
                item.innerHTML = `
                    <div class="response-event-header">
                        <div class="response-event-id">${eventData.response?.id || 'N/A'}</div>
                        <div class="response-event-time">${new Date(log.timestamp).toLocaleString('ru-RU')}</div>
                        <div class="response-event-type">response.done</div>
                    </div>
                    <div class="response-event-data">${JSON.stringify(eventData, null, 2)}</div>
                `;

                container.insertBefore(item, container.firstChild);

                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                const items = container.querySelectorAll('.response-event-item');
                if (items.length > 50) {
                    items[items.length - 1].remove();
                }
            }

            updateStats(status) {
                document.getElementById('transcriptionCount').textContent = status.transcriptionCount || 0;
                document.getElementById('logsCount').textContent = status.logsCount || 0;
                document.getElementById('relayStatus').textContent = status.isStreaming ? 'running' : 'stopped';
                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('ru-RU');
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä—â–∏–∫–∞
        const viewer = new TranscriptionViewer();
    </script>
</body>
</html>
