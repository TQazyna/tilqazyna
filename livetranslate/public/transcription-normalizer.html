<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transcription Normalizer with ChatGPT</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #f0f0f0;
            color: #000;
            line-height: 1.4;
            font-size: 12px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border: 1px solid #ccc;
        }

        .header {
            background: #2E7D32;
            color: white;
            padding: 15px;
            text-align: center;
            border-bottom: 3px solid #000;
        }

        .header h1 {
            font-size: 18px;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .header p {
            font-size: 12px;
        }

        .content {
            padding: 20px;
        }

        .controls {
            background: #fff;
            border: 1px solid #ccc;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        label {
            font-weight: bold;
            color: #000;
            font-size: 12px;
        }

        select, input {
            padding: 6px;
            border: 1px solid #999;
            font-size: 12px;
            min-width: 200px;
            background: #fff;
        }

        textarea {
            padding: 6px;
            border: 1px solid #999;
            font-size: 12px;
            width: 100%;
            background: #fff;
            font-family: monospace;
        }

        select:focus, input:focus, textarea:focus {
            outline: 2px solid #2E7D32;
            border-color: #2E7D32;
        }

        .btn {
            background: #2E7D32;
            color: white;
            border: 1px solid #000;
            padding: 6px 12px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
        }

        .btn:hover {
            background: #1B5E20;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #2E7D32;
            color: white;
            padding: 15px;
            border: 1px solid #000;
            text-align: center;
        }

        .stat-number {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            font-weight: bold;
        }

        .sections {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .section {
            border: 1px solid #ccc;
            background: white;
        }

        .section-header {
            background: #2E7D32;
            color: white;
            padding: 10px;
            font-weight: bold;
            text-align: center;
        }

        .section-content {
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
        }

        .transcription-item {
            background: #f5f5f5;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 3px;
        }

        .transcription-item.latest {
            border-color: #2E7D32;
            background: #E8F5E9;
        }

        .transcription-time {
            font-size: 11px;
            color: #666;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .transcription-text {
            font-size: 13px;
            color: #000;
        }

        .normalized-item {
            background: white;
            border: 1px solid #ccc;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 3px;
        }

        .normalized-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding-bottom: 5px;
            border-bottom: 1px solid #ddd;
        }

        .normalized-time {
            font-size: 11px;
            color: #666;
            font-weight: bold;
        }

        .normalized-status {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .normalized-status.success {
            background: #C8E6C9;
            color: #2E7D32;
        }

        .normalized-status.error {
            background: #FFCDD2;
            color: #C62828;
        }

        .normalized-text {
            font-size: 13px;
            color: #000;
            padding: 8px;
            background: #f9f9f9;
            border-radius: 3px;
            white-space: pre-wrap;
        }

        .normalized-error {
            font-size: 12px;
            color: #C62828;
            font-style: italic;
        }

        .log-item {
            background: white;
            border: 1px solid #ccc;
            padding: 8px;
            margin-bottom: 6px;
            font-family: monospace;
            font-size: 11px;
        }

        .log-timestamp {
            color: #000;
            font-weight: bold;
        }

        .log-type {
            color: #2E7D32;
            font-weight: bold;
            margin: 0 8px;
        }

        .log-message {
            color: #000;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #000;
            border: 1px solid #ccc;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #000;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .sections {
                grid-template-columns: 1fr;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .control-group {
                width: 100%;
            }

            select, input {
                min-width: auto;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ Transcription Normalizer with ChatGPT</h1>
            <p>–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ –∫–∞–∑–∞—Ö—Å–∫–æ–≥–æ —è–∑—ã–∫–∞ —á–µ—Ä–µ–∑ ChatGPT API</p>
        </div>

        <div class="content">
            <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
            <div class="controls">
                <div class="control-group">
                    <label for="relaySelect">–†–µ—Ç—Ä–∞–Ω—Å–ª—è—Ç–æ—Ä</label>
                    <select id="relaySelect">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ—Ç—Ä–∞–Ω—Å–ª—è—Ç–æ—Ä...</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="apiKeyInput">OpenAI API Key</label>
                    <input type="password" id="apiKeyInput" placeholder="sk-...">
                </div>
                <div class="control-group">
                    <button class="btn" id="normalizeBtn" disabled>üîÑ –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç</button>
                </div>
                <div class="control-group">
                    <label for="autoNormalize">
                        <input type="checkbox" id="autoNormalize" style="min-width: auto; width: auto;">
                        –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è
                    </label>
                </div>
            </div>

            <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–º–ø—Ç–∞ -->
            <div class="controls">
                <div class="control-group" style="flex: 1;">
                    <label for="promptInput">–ü—Ä–æ–º–ø—Ç –¥–ª—è ChatGPT</label>
                    <textarea id="promptInput" rows="4">–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∫–∞–∑–∞—Ö—Å–∫–æ–º—É —è–∑—ã–∫—É. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –∏—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫–∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ –∫–∞–∑–∞—Ö—Å–∫–æ–π —Ä–µ—á–∏ –∏ –ø—Ä–∏–≤–µ—Å—Ç–∏ —Ç–µ–∫—Å—Ç –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π, —á–∏—Ç–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç.

–ò—Å—Ö–æ–¥–Ω–∞—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å:
- –û—à–∏–±–∫–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏
- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞–ø–∏—Å–∞–Ω–Ω—ã–µ —Å–ª–æ–≤–∞
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∑–Ω–∞–∫–æ–≤ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è

–¢–≤–æ—è –∑–∞–¥–∞—á–∞:
1. –ò—Å–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ –æ—à–∏–±–∫–∏ –∫–∞–∑–∞—Ö—Å–∫–æ–≥–æ —è–∑—ã–∫–∞
2. –î–æ–±–∞–≤–∏—Ç—å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∑–Ω–∞–∫–∏ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è
3. –°–¥–µ–ª–∞—Ç—å —Ç–µ–∫—Å—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–Ω—è—Ç–Ω—ã–º –∏ –≥—Ä–∞–º–æ—Ç–Ω—ã–º
4. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–º—ã—Å–ª –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞

–í–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤.</textarea>
                </div>
            </div>

            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="stats" id="stats">
                <div class="stat-card">
                    <div class="stat-number" id="transcriptionCount">0</div>
                    <div class="stat-label">–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–π –ø–æ–ª—É—á–µ–Ω–æ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="normalizedCount">0</div>
                    <div class="stat-label">–ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–æ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="errorCount">0</div>
                    <div class="stat-label">–û—à–∏–±–æ–∫</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="connectionStatus">–û—Ç–∫–ª—é—á–µ–Ω–æ</div>
                    <div class="stat-label">–°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</div>
                </div>
            </div>

            <!-- –†–∞–∑–¥–µ–ª—ã -->
            <div class="sections">
                <!-- –ò—Å—Ö–æ–¥–Ω—ã–µ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ -->
                <div class="section">
                    <div class="section-header">üìù –ò—Å—Ö–æ–¥–Ω—ã–µ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 10)</div>
                    <div class="section-content" id="transcriptionList">
                        <div class="empty-state">
                            <h3>–ù–µ—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–π</h3>
                            <p>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ—Ç—Ä–∞–Ω—Å–ª—è—Ç–æ—Ä –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</p>
                        </div>
                    </div>
                </div>

                <!-- –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã -->
                <div class="section">
                    <div class="section-header">‚ú® –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã</div>
                    <div class="section-content" id="normalizedList">
                        <div class="empty-state">
                            <h3>–ù–µ—Ç –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤</h3>
                            <p>–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç"</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –õ–æ–≥–∏ -->
            <div class="section">
                <div class="section-header">üìã –õ–æ–≥–∏ —Å–∏—Å—Ç–µ–º—ã</div>
                <div class="section-content" id="logsList">
                    <div class="empty-state">
                        <h3>–ù–µ—Ç –ª–æ–≥–æ–≤</h3>
                        <p>–õ–æ–≥–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class TranscriptionNormalizer {
            constructor() {
                this.relays = [];
                this.currentRelayId = null;
                this.ws = null;
                this.transcriptions = [];
                this.maxTranscriptions = 10;
                this.normalizedResults = [];
                this.logs = [];
                this.stats = {
                    transcriptionCount: 0,
                    normalizedCount: 0,
                    errorCount: 0
                };
                this.init();
            }

            async init() {
                await this.loadRelays();
                this.setupEventListeners();
                this.loadApiKeyFromStorage();
                this.loadPromptFromStorage();
            }

            loadApiKeyFromStorage() {
                const apiKey = localStorage.getItem('openai_api_key');
                if (apiKey) {
                    document.getElementById('apiKeyInput').value = apiKey;
                }
            }

            loadPromptFromStorage() {
                const prompt = localStorage.getItem('normalizer_prompt');
                if (prompt) {
                    document.getElementById('promptInput').value = prompt;
                }
            }

            saveApiKeyToStorage() {
                const apiKey = document.getElementById('apiKeyInput').value;
                if (apiKey) {
                    localStorage.setItem('openai_api_key', apiKey);
                }
            }

            savePromptToStorage() {
                const prompt = document.getElementById('promptInput').value;
                localStorage.setItem('normalizer_prompt', prompt);
            }

            async loadRelays() {
                try {
                    const response = await fetch('/api/rtmp-relay');
                    this.relays = await response.json();

                    const relaySelect = document.getElementById('relaySelect');
                    relaySelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ—Ç—Ä–∞–Ω—Å–ª—è—Ç–æ—Ä...</option>';

                    this.relays.forEach(relay => {
                        const option = document.createElement('option');
                        option.value = relay.id;
                        option.textContent = `${relay.id} (${relay.status}) - ${relay.rtmpUrl}`;
                        relaySelect.appendChild(option);
                    });
                } catch (error) {
                    this.addLog('error', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ—Ç—Ä–∞–Ω—Å–ª—è—Ç–æ—Ä–æ–≤', error.message);
                }
            }

            setupEventListeners() {
                document.getElementById('relaySelect').addEventListener('change', (e) => {
                    this.currentRelayId = e.target.value;
                    if (this.currentRelayId) {
                        this.connectWebSocket();
                    } else {
                        this.disconnectWebSocket();
                    }
                });

                document.getElementById('apiKeyInput').addEventListener('change', () => {
                    this.saveApiKeyToStorage();
                    this.updateNormalizeButton();
                });

                document.getElementById('promptInput').addEventListener('change', () => {
                    this.savePromptToStorage();
                });

                document.getElementById('normalizeBtn').addEventListener('click', () => {
                    this.normalizeTranscriptions();
                });

                document.getElementById('autoNormalize').addEventListener('change', (e) => {
                    if (e.target.checked) {
                        this.addLog('info', '–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –≤–∫–ª—é—á–µ–Ω–∞');
                    } else {
                        this.addLog('info', '–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –≤—ã–∫–ª—é—á–µ–Ω–∞');
                    }
                });
            }

            updateNormalizeButton() {
                const apiKey = document.getElementById('apiKeyInput').value;
                const hasTranscriptions = this.transcriptions.length > 0;
                document.getElementById('normalizeBtn').disabled = !apiKey || !hasTranscriptions;
            }

            connectWebSocket() {
                this.disconnectWebSocket();

                if (!this.currentRelayId) return;

                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/transcription?relay=${this.currentRelayId}`;

                this.ws = new WebSocket(wsUrl);

                this.ws.onopen = () => {
                    this.addLog('success', 'WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω', this.currentRelayId);
                    document.getElementById('connectionStatus').textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
                };

                this.ws.onmessage = (event) => {
                    try {
                        const message = JSON.parse(event.data);
                        this.handleWebSocketMessage(message);
                    } catch (error) {
                        this.addLog('error', '–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ WebSocket —Å–æ–æ–±—â–µ–Ω–∏—è', error.message);
                    }
                };

                this.ws.onclose = () => {
                    this.addLog('info', 'WebSocket –æ—Ç–∫–ª—é—á–µ–Ω');
                    document.getElementById('connectionStatus').textContent = '–û—Ç–∫–ª—é—á–µ–Ω–æ';
                    // –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
                    setTimeout(() => {
                        if (this.currentRelayId) {
                            this.connectWebSocket();
                        }
                    }, 3000);
                };

                this.ws.onerror = (error) => {
                    this.addLog('error', 'WebSocket –æ—à–∏–±–∫–∞', error.message);
                };
            }

            disconnectWebSocket() {
                if (this.ws) {
                    this.ws.close();
                    this.ws = null;
                }
            }

            handleWebSocketMessage(message) {
                switch (message.type) {
                    case 'initial_data':
                        if (message.data.transcription) {
                            // –ë–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10
                            this.transcriptions = message.data.transcription.slice(0, this.maxTranscriptions);
                            this.stats.transcriptionCount = this.transcriptions.length;
                            this.renderTranscriptions();
                            this.updateStats();
                            this.updateNormalizeButton();
                        }
                        break;
                    case 'transcription':
                        this.addTranscription(message.data);
                        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–∞
                        if (document.getElementById('autoNormalize').checked) {
                            this.normalizeTranscriptions();
                        }
                        break;
                }
            }

            addTranscription(transcription) {
                // –î–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–∞—á–∞–ª–æ –º–∞—Å—Å–∏–≤–∞
                this.transcriptions.unshift(transcription);

                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–æ 10 —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                if (this.transcriptions.length > this.maxTranscriptions) {
                    this.transcriptions = this.transcriptions.slice(0, this.maxTranscriptions);
                }

                this.stats.transcriptionCount = this.transcriptions.length;
                this.renderTranscriptions();
                this.updateStats();
                this.updateNormalizeButton();

                this.addLog('info', '–ù–æ–≤–∞—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∞', transcription.transcript);
            }

            renderTranscriptions() {
                const container = document.getElementById('transcriptionList');

                if (this.transcriptions.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>–ù–µ—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–π</h3>
                            <p>–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = this.transcriptions.map((item, index) => `
                    <div class="transcription-item ${index === 0 ? 'latest' : ''}">
                        <div class="transcription-time">${new Date(item.timestamp).toLocaleString('ru-RU')}</div>
                        <div class="transcription-text">${item.transcript}</div>
                    </div>
                `).join('');
            }

            async normalizeTranscriptions() {
                const apiKey = document.getElementById('apiKeyInput').value;
                const prompt = document.getElementById('promptInput').value;

                if (!apiKey) {
                    this.addLog('error', 'API –∫–ª—é—á –Ω–µ —É–∫–∞–∑–∞–Ω');
                    return;
                }

                if (this.transcriptions.length === 0) {
                    this.addLog('error', '–ù–µ—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–π –¥–ª—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏');
                    return;
                }

                // –°–æ–±–∏—Ä–∞–µ–º —Ç–µ–∫—Å—Ç –∏–∑ –≤—Å–µ—Ö —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–π
                const combinedText = this.transcriptions
                    .map(t => t.transcript)
                    .join('\n');

                this.addLog('info', '–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ ChatGPT', `${this.transcriptions.length} —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–π`);

                try {
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: 'gpt-4',
                            messages: [
                                {
                                    role: 'system',
                                    content: prompt
                                },
                                {
                                    role: 'user',
                                    content: combinedText
                                }
                            ],
                            temperature: 0.3,
                            max_tokens: 2000
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || 'API request failed');
                    }

                    const data = await response.json();
                    const normalizedText = data.choices[0].message.content;

                    this.addNormalizedResult({
                        timestamp: new Date().toISOString(),
                        originalTexts: this.transcriptions.map(t => t.transcript),
                        normalizedText: normalizedText,
                        success: true
                    });

                    this.stats.normalizedCount++;
                    this.updateStats();
                    this.addLog('success', '–¢–µ–∫—Å—Ç —É—Å–ø–µ—à–Ω–æ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω');

                } catch (error) {
                    this.addNormalizedResult({
                        timestamp: new Date().toISOString(),
                        error: error.message,
                        success: false
                    });

                    this.stats.errorCount++;
                    this.updateStats();
                    this.addLog('error', '–û—à–∏–±–∫–∞ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏', error.message);
                }
            }

            addNormalizedResult(result) {
                this.normalizedResults.unshift(result);

                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–æ 20 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                if (this.normalizedResults.length > 20) {
                    this.normalizedResults = this.normalizedResults.slice(0, 20);
                }

                this.renderNormalizedResults();
            }

            renderNormalizedResults() {
                const container = document.getElementById('normalizedList');

                if (this.normalizedResults.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>–ù–µ—Ç –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤</h3>
                            <p>–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç"</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = this.normalizedResults.map(result => `
                    <div class="normalized-item">
                        <div class="normalized-header">
                            <div class="normalized-time">${new Date(result.timestamp).toLocaleString('ru-RU')}</div>
                            <div class="normalized-status ${result.success ? 'success' : 'error'}">
                                ${result.success ? '–£—Å–ø–µ—à–Ω–æ' : '–û—à–∏–±–∫–∞'}
                            </div>
                        </div>
                        ${result.success
                            ? `<div class="normalized-text">${result.normalizedText}</div>`
                            : `<div class="normalized-error">–û—à–∏–±–∫–∞: ${result.error}</div>`
                        }
                    </div>
                `).join('');
            }

            updateStats() {
                document.getElementById('transcriptionCount').textContent = this.stats.transcriptionCount;
                document.getElementById('normalizedCount').textContent = this.stats.normalizedCount;
                document.getElementById('errorCount').textContent = this.stats.errorCount;
            }

            addLog(type, message, details = null) {
                const logEntry = {
                    timestamp: new Date().toISOString(),
                    type: type,
                    message: message,
                    details: details
                };

                this.logs.unshift(logEntry);

                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–æ 50 –ª–æ–≥–æ–≤
                if (this.logs.length > 50) {
                    this.logs = this.logs.slice(0, 50);
                }

                this.renderLogs();
                console.log(`[${type}] ${message}`, details || '');
            }

            renderLogs() {
                const container = document.getElementById('logsList');

                if (this.logs.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>–ù–µ—Ç –ª–æ–≥–æ–≤</h3>
                            <p>–õ–æ–≥–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = this.logs.map(log => `
                    <div class="log-item">
                        <span class="log-timestamp">${new Date(log.timestamp).toLocaleString('ru-RU')}</span>
                        <span class="log-type">[${log.type}]</span>
                        <span class="log-message">${log.message}</span>
                        ${log.details ? `<div style="margin-top: 5px; color: #666;">${log.details}</div>` : ''}
                    </div>
                `).join('');
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        const normalizer = new TranscriptionNormalizer();
    </script>
</body>
</html>
