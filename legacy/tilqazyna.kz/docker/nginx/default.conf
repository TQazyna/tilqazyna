server {
    listen 80;
    server_name _;

    client_max_body_size 128m;

    # Resolve container names (podman internal DNS). Adjust if resolv.conf differs.
    resolver 10.89.8.1 ipv6=off valid=30s;
    set $php_upstream php:9000;

    set $base_root /app;
    root $base_root;
    index index.php index.html;
    charset utf-8;

    location / {
        root $base_root/frontend/web;
        try_files $uri $uri/ /frontend/web/index.php?$args;

        location ~ ^/assets/.+\.php(/|$) {
            deny all;
        }
    }

    location /img/banners/ {
        if (-f $request_filename) { break; }
        rewrite ^(.*)$ /index.php?q=$1 last;
    }

    location /admin {
        alias $base_root/backend/web/;
        try_files $uri /backend/web/index.php?$args;

        location ~ ^/assets/.+\.php(/|$) {
            deny all;
        }

        location ~* ^.+\.(css|jpg|jpeg|gif|png|ico|zip|tgz|gz|rar|bz2|doc|xls|pdf|ppt|txt|tar|mid|midi|wav|bmp|rtf|js|html|swf)$ {
            expires max;
            access_log off;
        }

        location ~ \.php$ {
            try_files $uri /backend/web/index.php?$args;
            fastcgi_pass $php_upstream;
            fastcgi_index index.php;
            fastcgi_split_path_info ^/backend/web/(.+\.php)(.*)$;
            include fastcgi_params;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            fastcgi_param PHP_VALUE "output_buffering=4096";
        }
    }

    location ~ ^/.+\.php(/|$) {
        rewrite (?!^/((frontend|backend)/web|admin))^ /frontend/web$uri break;
        rewrite (?!^/backend/web)^/admin(/.+)$ /backend/web$1 break;

        include fastcgi_params;
        fastcgi_pass $php_upstream;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param HTTPS off;
        fastcgi_param PHP_VALUE "output_buffering=4096";
    }

    location ~* \.(js|css|png|jpg|jpeg|gif|ico)$ {
        expires max;
        log_not_found off;
        access_log off;
        root $base_root/frontend/web;
        if (-f $request_filename) { break; }
        rewrite ^(.*)$ /index.php?q=$1 last;
    }

    location ^~ /.well-known/acme-challenge/ {
        allow all;
        default_type "text/plain";
        root $base_root/frontend/web;
    }
}


